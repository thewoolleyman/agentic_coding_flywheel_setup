name: Installer CI

on:
  push:
    branches: [main]
    paths:
      - 'install.sh'
      - 'scripts/**'
      - 'acfs.manifest.yaml'
      - 'checksums.yaml'
      - 'packages/manifest/**'
      - '.github/workflows/installer.yml'
      - '.shellcheckrc'
      - 'tests/**/*.sh'
  pull_request:
    branches: [main]
    paths:
      - 'install.sh'
      - 'scripts/**'
      - 'acfs.manifest.yaml'
      - 'checksums.yaml'
      - 'packages/manifest/**'
      - '.github/workflows/installer.yml'
      - '.shellcheckrc'
      - 'tests/**/*.sh'

jobs:
  shellcheck:
    name: ShellCheck
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install ShellCheck
        run: |
          sudo apt-get update
          sudo apt-get install -y shellcheck

      - name: Run ShellCheck
        shell: bash
        run: |
          mapfile -t files < <(git ls-files '*.sh')
          shellcheck "${files[@]}"

  manifest-drift:
    name: Manifest Drift Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install
        working-directory: packages/manifest

      - name: Check manifest drift
        run: bun run generate --diff
        working-directory: packages/manifest

  selection-tests:
    name: Selection & Contract Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run selection tests
        run: bash scripts/lib/test_selection.sh

      - name: Run contract tests
        run: bash scripts/lib/test_contract.sh

      - name: Run security tests
        run: bash scripts/lib/test_security.sh

      - name: Run install helpers tests
        run: bash scripts/lib/test_install_helpers.sh

  test-installer:
    name: Test installer (Ubuntu ${{ matrix.ubuntu }}, mode ${{ matrix.mode }})
    runs-on: ubuntu-latest
    timeout-minutes: 60
    strategy:
      fail-fast: false
      matrix:
        include:
          - ubuntu: '24.04'
            mode: vibe
          - ubuntu: '25.04'
            mode: vibe
          - ubuntu: '24.04'
            mode: safe
    container:
      image: ubuntu:${{ matrix.ubuntu }}
    env:
      DEBIAN_FRONTEND: noninteractive
    steps:
      - name: Install container prerequisites
        working-directory: /
        run: |
          apt-get update
          apt-get install -y sudo curl git ca-certificates jq unzip tar xz-utils gnupg

      - name: Checkout
        uses: actions/checkout@v4

      - name: Offline bootstrap simulation
        run: |
          bash tests/vm/bootstrap_offline_checks.sh

      - name: Run installer
        run: |
          # Skip preflight in CI - GitHub Actions containers have limited disk (17GB < 20GB required)
          # Skip Ubuntu upgrade in CI - containers can't reboot during workflow
          bash install.sh --yes --skip-preflight --skip-ubuntu-upgrade --mode ${{ matrix.mode }}

      - name: Run doctor
        run: |
          su - ubuntu -c "zsh -ic 'acfs doctor'"

      - name: Verify key tools
        run: |
          su - ubuntu -c "zsh -ic 'test -f ~/.acfs/VERSION'"
          su - ubuntu -c "zsh -ic 'gh --version'"
          su - ubuntu -c "zsh -ic 'jq --version'"
          su - ubuntu -c "zsh -ic 'sg --version'"
          su - ubuntu -c "zsh -ic 'git-lfs version'"
          su - ubuntu -c "zsh -ic 'rsync --version'"
          su - ubuntu -c "zsh -ic 'strace --version'"
          su - ubuntu -c "zsh -ic 'command -v lsof >/dev/null'"
          su - ubuntu -c "zsh -ic 'command -v dig >/dev/null'"
          su - ubuntu -c "zsh -ic 'command -v nc >/dev/null'"
          su - ubuntu -c "zsh -ic 'ntm --help'"
          su - ubuntu -c "zsh -ic 'ubs --help'"
          su - ubuntu -c "zsh -ic 'bv --help'"
          su - ubuntu -c "zsh -ic 'cass --help'"
          su - ubuntu -c "zsh -ic 'cm --help'"
          su - ubuntu -c "zsh -ic 'caam --help'"
          su - ubuntu -c "zsh -ic 'slb --help'"
          su - ubuntu -c "zsh -ic 'onboard --help'"
          su - ubuntu -c "zsh -ic 'claude --version'"
          su - ubuntu -c "zsh -ic 'codex --version'"
          su - ubuntu -c "zsh -ic 'gemini --version'"
