#!/usr/bin/env bash
# ============================================================
# ACFS Global Wrapper
# Installed to /usr/local/bin/acfs for system-wide access
#
# This wrapper ensures the acfs command works regardless of
# which user invokes it (root or target user).
# ============================================================

set -euo pipefail

# Optional override for state file location.
# If unset, we auto-detect from common install locations.
ACFS_STATE_FILE="${ACFS_STATE_FILE:-}"

is_valid_username() {
    local username="$1"
    [[ "$username" =~ ^[a-z_][a-z0-9_-]*$ ]]
}

read_target_user_from_state_file() {
    local state_file="$1"
    local target_user=""

    [[ -f "$state_file" ]] || return 1

    # Try jq first (faster and more reliable)
    if command -v jq &>/dev/null; then
        target_user="$(jq -r '.target_user // empty' "$state_file" 2>/dev/null || true)"
    fi

    # Fall back to sed if jq not available / parse fails
    if [[ -z "$target_user" ]]; then
        target_user="$(sed -n 's/.*"target_user"[[:space:]]*:[[:space:]]*"\([^"]*\)".*/\1/p' "$state_file" | head -n 1)"
    fi

    if [[ -n "$target_user" ]] && is_valid_username "$target_user"; then
        printf '%s\n' "$target_user"
        return 0
    fi

    return 1
}

# Detect target user from state file(s) or default to ubuntu
detect_target_user() {
    local state_candidate

    if [[ -n "${ACFS_STATE_FILE:-}" ]] && read_target_user_from_state_file "$ACFS_STATE_FILE"; then
        return 0
    fi

    # 1) Current user's installed state (works when invoked as the target user)
    if read_target_user_from_state_file "$HOME/.acfs/state.json"; then
        return 0
    fi

    # 2) Common default target user
    if read_target_user_from_state_file "/home/ubuntu/.acfs/state.json"; then
        return 0
    fi

    # 3) Scan for an installed state file under /home/*
    for state_candidate in /home/*/.acfs/state.json; do
        if read_target_user_from_state_file "$state_candidate"; then
            return 0
        fi
    done

    # 4) Upgrade/resume state file (root-owned, may remain after upgrades)
    if read_target_user_from_state_file "/var/lib/acfs/state.json"; then
        return 0
    fi

    echo "ubuntu"
}

# Find acfs installation for a user
find_acfs_bin() {
    local user="$1"
    local user_home

    # Get user's home directory
    user_home="$(getent passwd "$user" 2>/dev/null | cut -d: -f6)" || true
    if [[ -z "$user_home" ]]; then
        user_home="/home/$user"
    fi

    # Check standard locations
    if [[ -x "$user_home/.local/bin/acfs" ]]; then
        echo "$user_home/.local/bin/acfs"
    elif [[ -x "$user_home/.acfs/bin/acfs" ]]; then
        echo "$user_home/.acfs/bin/acfs"
    else
        return 1
    fi
}

main() {
    local target_user
    local acfs_bin
    local current_user

    target_user="$(detect_target_user)"
    current_user="$(whoami)"

    # Find the acfs binary
    if ! acfs_bin="$(find_acfs_bin "$target_user")"; then
        echo "Error: ACFS not found for user '$target_user'" >&2

        local target_home
        target_home="$(getent passwd "$target_user" 2>/dev/null | cut -d: -f6)" || true
        target_home="${target_home:-/home/$target_user}"

        echo "Expected at: $target_home/.local/bin/acfs (or $target_home/.acfs/bin/acfs)" >&2

        # Try to help the user identify other installs (common cases: installed under a different /home user).
        local -a candidates=()
        local candidate candidate_user
        shopt -s nullglob
        candidates=(/home/*/.local/bin/acfs /home/*/.acfs/bin/acfs /root/.local/bin/acfs /root/.acfs/bin/acfs)
        shopt -u nullglob

        if (( ${#candidates[@]} > 0 )); then
            echo "" >&2
            echo "Detected other ACFS installs:" >&2
            for candidate in "${candidates[@]}"; do
                [[ -x "$candidate" ]] || continue

                if [[ "$candidate" == /home/* ]]; then
                    candidate_user="$(printf '%s' "$candidate" | cut -d/ -f3)"
                elif [[ "$candidate" == /root/* ]]; then
                    candidate_user="root"
                else
                    candidate_user=""
                fi

                if [[ -n "$candidate_user" ]]; then
                    echo "  - $candidate_user: $candidate" >&2
                    echo "    Try: sudo -u \"$candidate_user\" -H -- \"$0\" [args...]" >&2
                else
                    echo "  - $candidate" >&2
                fi
            done
        fi

        echo "" >&2
        echo "If ACFS was installed for a different user, run this wrapper as that user, e.g.:" >&2
        echo "  sudo -u <user> -H -- \"$0\" [args...]" >&2
        echo "" >&2
        echo "You can also override state discovery:" >&2
        echo "  ACFS_STATE_FILE=/path/to/state.json \"$0\" [args...]" >&2
        exit 1
    fi

    # If we're already the target user, run directly
    if [[ "$current_user" == "$target_user" ]]; then
        exec "$acfs_bin" "$@"
    fi

    # If we're root, run as target user
    if [[ "$EUID" -eq 0 ]]; then
        # IMPORTANT: Avoid `sudo -i` which sources shell profile files.
        # Third-party installers sometimes modify those files in ways that can
        # break non-interactive runs. We set HOME with `-H` but preserve CWD.
        exec sudo -u "$target_user" -H -- "$acfs_bin" "$@"
    fi

    # Otherwise, we need sudo to switch users
    echo "Note: Running acfs as '$target_user' (ACFS owner)" >&2
    exec sudo -u "$target_user" -H -- "$acfs_bin" "$@"
}

main "$@"
