#!/usr/bin/env bash
# ============================================================
# ACFS Update Wrapper
# Provides a global `acfs-update` command that dispatches to update.sh
# ============================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

find_update_script() {
  local candidate=""

  # Respect ACFS_HOME if set (installed location)
  if [[ -n "${ACFS_HOME:-}" ]] && [[ -f "${ACFS_HOME}/scripts/lib/update.sh" ]]; then
    candidate="${ACFS_HOME}/scripts/lib/update.sh"
    echo "$candidate"
    return 0
  fi

  # Repo-relative path (running from source)
  if [[ -f "${SCRIPT_DIR}/lib/update.sh" ]]; then
    candidate="${SCRIPT_DIR}/lib/update.sh"
    echo "$candidate"
    return 0
  fi

  # Installed path (after install.sh)
  if [[ -f "$HOME/.acfs/scripts/lib/update.sh" ]]; then
    candidate="$HOME/.acfs/scripts/lib/update.sh"
    echo "$candidate"
    return 0
  fi

  return 1
}

UPDATE_SCRIPT="$(find_update_script || true)"

if [[ -z "${UPDATE_SCRIPT:-}" ]]; then
  echo "Error: update.sh not found." >&2
  echo "Run from the repo or install ACFS first." >&2
  exit 1
fi

exec bash "$UPDATE_SCRIPT" "$@"
